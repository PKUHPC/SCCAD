{% extends "layout.html" %}

{% block head %}
    <link rel="stylesheet" href="/static/css/stat.css">
{% endblock %}

{% macro donut_info(type) %}
    {% macro item_a(info,cls) %}
        <a href="{{url_for('node_index',cluster=page['cluster_show'])}}" class="list-group-item">{{info}}
            <span class="pull-right text-muted ">
                <em class="{{type}}_{{cls}}">0</em>
            </span>
        </a>
    {% endmacro %}

    <div class="list-group list-group-flush">
        {{item_a(_("Total"),"tot")}}
        {{item_a(_("Available"),"free")}}
        {{item_a(_("Running"),"alloc")}}
        {{item_a(_("Error"),"error")}}
    </div>
{% endmacro %}

{% macro line_chart_date(type) %}
    {% macro item_li(value,info) %}
        <li class="nav-item m-2">
            <a class="nav-link history {{type}}" value="{{value}}">{{info}}</a>
        </li>
    {% endmacro%}

    <ul class="nav nav-pills nav-fill" id="{{type}}-legden">
        {{item_li("2-DAY",_('2 DAYS'))}}
        {{item_li("7-DAY",_('7 DAYS'))}}
        {{item_li("30-DAY",_('30 DAYS'))}}
        {{item_li("2-MONTH",_('2 MONTHS'))}}
        {{item_li("6-MONTH",_('6 MONTHS'))}}
        {{item_li("12-MONTH",_('1 YEAR'))}}
    </ul>
    <ul class="nav nav-pills nav-fill">
        <li class="nav-item m-2">
            <input type="date" class="form-control start-date" placeholder='{{_("start-date")}}' >
        </li>
        <li class="nav-item m-2">
            <input type="date" class="form-control end-date" placeholder='{{_("end-date")}}'>
        </li>
        <li class="nav-item m-2">
            <button type="button" class="btn btn-primary btn-block history check {{type}}">{{_("Query")}}</button>
        </li>
    </ul>
{% endmacro %}

{% block body %}

    <!-- {% block brief %}
    <h5>{{_("Clusters Overview")}}</h5>
        <div class="row">
            <div class="col-md-4">
                <h6 class="my-2 text-center">{{_("Node Usage")}}</h6>
                <div id="brief-node-chart" class="brief-bar"></div>
            </div>
            <div class="col-md-4">
                <h6 class="my-2 text-center">{{_("Core Usage")}}</h6>
                <div id="brief-cpu-chart" class="brief-bar"></div>
            </div>
            <div class="col-md-4">
                <h6 class="my-2 text-center">{{_("Job")}}</h6>
                <div id="brief-job-chart" class="brief-bar"></div>
            </div>
        </div>
    <hr>
    {% endblock %} -->
    {{ super() }}

    {% block body_content%}

    <div class="row">
        <div class="col-lg-8">
            <div class="row">
            {% for info_item in page['nodes'] %}
                <div class="col-sm-{{info_item['size']}} stat-chart-{{info_item['size']}}  p-3" id="{{ info_item['id'] }}">
                    <h5>{{ info_item["name"] }}</h5>
                    <div class="row">
                        <div class="col col-sm-6">
                            <h6 class="text-center chart_header">{{_("Nodes")}}</h6>
                            {{ donut_info('node') }}
                            <div id="{{info_item["id"]}}-node-chart" class="donut-chart"></div>
                        </div>

                        <div class="col col-sm-6">
                            <h6 class="text-center chart_header cpu_title">{{_("Cores")}}</h6>
                            <h6 class="text-center chart_header gpu_title" style="display:none">{{_("GPUs")}}</h6>
                            {{ donut_info('cpu') }}
                            <div id="{{info_item["id"]}}-cpu-chart" class="donut-chart"></div>
                        </div>
                    </div>
                </div>
            {% endfor %}
            </div>
        </div>

        <div class="col-lg-4">
            <div class="row">
                <div class="col-md-12 p-3">
                    <h5 class="mb-2">{{_("Job Information")}}</h5>
                    <div class="list-group list-group-flush" id="job-info">
                        <p class="lead my-2">LOADING......</p>
                    </div>
                </div>

                <div class="col-lg-12 col-sm-6 p-3">
                    <h5 class="mb-2">{{_("TOP5 Job Pending Time")}} </h5>
                    <div class="list-group list-group-flush" id="job-waiting">
                        <p class="lead my-2">LOADING......</p>
                    </div>
                </div>

                <div class="col-lg-12 col-sm-6 p-3">
                    <h5 class="mb-2">{{_("TOP5 Job Running Time")}}</h5>
                    <div class="list-group list-group-flush" id="job-running">
                        <p class="lead my-2">LOADING......</p>
                    </div>
                </div>

                {% block pue_content %}{% endblock %}
            </div>
        </div>
    </div>
    <!-- <hr> -->
    <div class="row" id="history">
        <div class="col-lg-6 my-2">
            <h5 class="m-3">{{_("Nodes Usage History")}}</h5>
            {{line_chart_date("node")}}
            <div id="node_chart" style="height:400px"></div>
            <div class="flot-info m-2"></div>
        </div><!-- /.col-lg-6 -->

        <div class="col-lg-6  my-2">

            <h5 class="m-3">{{_("User Job History")}}</h5>
            {{line_chart_date("user")}}
            <div id="user_chart" style="height:400px;"></div>
            <div class="flot-info m-2"></div>
        </div><!-- /.col-lg-6 -->

        {% block history %}
        {% endblock %}

    </div>
    {% endblock %}
{% endblock %}

{% block bottom %}
    {{super()}}
    <script src="/static/js/echarts.min.js"></script>
    <script src="/static/js/stat.js"></script>
    <script>
        var page = {{ page.nodes|tojson|safe }}
        function urls(action,params){
            if(params==null){params = {}}
            if(action=="async"){
                return "{{url_for('stat_async',cluster=page['cluster'])}}"
            }else if (action=="history") {
                var type = ((params.type) ? params.type : "nodeuserpue");
                var period = ((params.period) ? params.period : "2-DAY");
                var target = "{{url_for('stat_history',cluster=page['cluster'],type='target-type',period='target-period')}}"
                ret = target.replace("target-type",type).replace("target-period",period)
                return ret
            }else if (action=="history_check") {
                var type = ((params.type) ? params.type : "nodeuserpue");
                var start_date = ((params.start_date) ? params.start_date : "2018-01-01");
                var end_date = ((params.end_date) ? params.end_date : "2018-01-02");
                var target = "{{url_for('stat_history_check',cluster=page['cluster'],type='target-type',start_date='target-start-date',end_date='target-end-date')}}"
                ret = target.replace("target-type",type).replace("target-start-date",start_date).replace("target-end-date",end_date)
                return ret
            }else if (action=="job"){
                return "{{url_for('job_index',cluster=page['cluster_show'])}}"
            }else if (action=="node"){
                return "{{url_for('node_index',cluster=page['cluster_show'])}}"
            }
        }
        // history info
        function get_info(title,dataset,suffix){
            var max=0
            var min=10000000
            var sum=0
            for(i=1;i<dataset.length;i++){
                max = Math.max(max,dataset[i].value[1])
                min = Math.min(min,dataset[i].value[1])
                sum = sum+dataset[i].value[1]
            }
            var avg=sum/dataset.length
            return "<p class='text-center'>"+title+" {{_('MAX:')}}"+max+suffix+"  {{_('MIN:')}}"+min+suffix+"  {{_('AVG:')}}"+avg.toFixed(2)+suffix+"</p>"
        }

        var PanelList = function(list_info,job_url){
            var id = list_info.id
            var base_template = "\
            <a href='"+job_url+"' class='list-group-item'>\
                __left__\
                <span class='pull-right text-muted'><em>__right__</em>\
                </span>\
            </a>".toString()

            this.setup_content = function(data){
                var content = ""
                for (index in data){
                    for (k in data[index]){
                        content = content + base_template.replace("__left__",k).replace("__right__",data[index][k])
                    }
                }
                if(content == ""){
                    content = '<p class="lead my-2">{{_("No Data")}}</p>'
                }
                $("#"+id).html(content)
            }
        }
    </script>
{% endblock %}
